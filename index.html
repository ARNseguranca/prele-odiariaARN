<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Preleção Diária - Checklist e Postos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:0; background:#f7f9fc;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    align-items: flex-start;
    padding: 20px;
  }
  #app {
    background: white;
    max-width: 700px;
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(0,0,0,0.1);
    padding: 20px 30px 40px;
  }
  h2 {
    margin-top: 0;
    color: #003366;
    text-align: center;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
  }
  input[type=text], input[type=date], input[type=time], textarea, select {
    width: 100%;
    padding: 8px 10px;
    margin-top: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 14px;
  }
  textarea {
    resize: vertical;
    min-height: 60px;
  }
  .signature-pad {
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-top: 6px;
    width: 100%;
    height: 150px;
    touch-action: none;
  }
  button {
    background: #003366;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 25px;
  }
  button:disabled {
    background: #999;
    cursor: not-allowed;
  }
  .hidden {
    display: none;
  }
  .alteracao-area {
    margin-top: 10px;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
    background: #f9f9f9;
  }
  @media (max-width:600px) {
    #app {
      padding: 15px 20px 30px;
    }
    .signature-pad {
      height: 120px;
    }
  }
</style>
</head>
<body>

<div id="app">

  <!-- Páginas do wizard -->
  
  <!-- Página 0: Preleção diária -->
  <section class="page" data-page="0">
    <h2>Preleção Diária</h2>
    
    <label>Assuntos Tratados</label>
    <textarea id="assuntosTratados" required placeholder="Descreva os assuntos tratados na preleção"></textarea>
    
    <label>Colaboradores Presentes</label>
    <textarea id="colaboradoresPresentes" required placeholder="Liste os colaboradores presentes"></textarea>
    
    <label>Data</label>
    <input type="date" id="data" required>
    
    <label>Hora</label>
    <input type="time" id="hora" required>
    
    <label>Encarregado Responsável</label>
    <input type="text" id="encarregado" required placeholder="Nome do encarregado responsável">
    
    <label>Local</label>
    <input type="text" id="local" required placeholder="Local da preleção">
    
    <button id="btnProximo">Próximo</button>
  </section>

  <!-- Páginas dos postos serão criadas via JS -->

</div>

<!-- Import jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const postos = [
    "Portaria Principal",
    "Guarita 01",
    "Guarita 02",
    "Guarita Caminhão",
    "Central de Monitoramento",
    "Correspondência",
    "Vigia Área de Lazer",
    "Rondas Norte",
    "Rondas Sul"
  ];

  let currentPage = 0; // 0 = preleção, 1..n = postos
  const totalPages = postos.length + 1;

  const app = document.getElementById('app');

  // Cria as páginas dos postos dinamicamente
  postos.forEach((posto, index) => {
    const page = document.createElement('section');
    page.classList.add('page');
    page.dataset.page = (index + 1).toString();
    page.classList.add('hidden');

    page.innerHTML = `
      <h2>Posto: ${posto}</h2>
      
      <label>Houve alteração no posto?</label>
      <select class="alteracao-select" required>
        <option value="">Selecione</option>
        <option value="sim">Sim</option>
        <option value="nao">Não</option>
      </select>
      
      <div class="alteracao-area hidden">
        <label>Descrição da alteração</label>
        <textarea class="descricao-alteracao" placeholder="Descreva a alteração"></textarea>
        
        <label>Imagem da alteração (opcional)</label>
        <input type="file" accept="image/*" class="input-imagem-alteracao" />
      </div>
      
      <label>Nome do colaborador que está assumindo o posto</label>
      <input type="text" class="nome-colaborador" required placeholder="Nome completo">
      
      <label>Assinatura</label>
      <canvas class="signature-pad"></canvas>
      <button class="btn-clear-signature" type="button">Limpar assinatura</button>
      
      <button class="btn-next-posto" type="button">${index === postos.length - 1 ? 'Gerar PDF' : 'Próximo posto'}</button>
    `;
    app.appendChild(page);
  });

  // Mostra apenas a página atual
  function showPage(pageNum) {
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    const pageToShow = document.querySelector(`.page[data-page="${pageNum}"]`);
    if(pageToShow) pageToShow.classList.remove('hidden');
  }

  showPage(currentPage);

  // Configura data e hora automáticos no form preleção
  const dataInput = document.getElementById('data');
  const horaInput = document.getElementById('hora');
  function setCurrentDateTime() {
    const now = new Date();
    dataInput.value = now.toISOString().split('T')[0];
    horaInput.value = now.toTimeString().slice(0,5);
  }
  setCurrentDateTime();

  // Avançar página ao clicar em Próximo na preleção
  document.getElementById('btnProximo').addEventListener('click', () => {
    // valida campos obrigatórios preleção
    const assuntos = document.getElementById('assuntosTratados').value.trim();
    const colaboradores = document.getElementById('colaboradoresPresentes').value.trim();
    const encarregado = document.getElementById('encarregado').value.trim();
    const local = document.getElementById('local').value.trim();

    if(!assuntos || !colaboradores || !dataInput.value || !horaInput.value || !encarregado || !local) {
      alert('Por favor, preencha todos os campos obrigatórios da Preleção.');
      return;
    }

    currentPage++;
    showPage(currentPage);
  });

  // Gerenciamento das assinaturas com canvas
  class SignaturePadWrapper {
    constructor(canvas) {
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.isDrawing = false;
      this.lastX = 0;
      this.lastY = 0;
      this.resize();
      this.attachEvents();
    }

    resize() {
      const ratio = window.devicePixelRatio || 1;
      this.canvas.width = this.canvas.offsetWidth * ratio;
      this.canvas.height = this.canvas.offsetHeight * ratio;
      this.ctx.scale(ratio, ratio);
      this.ctx.lineCap = 'round';
      this.ctx.strokeStyle = '#000';
      this.ctx.lineWidth = 2;
      this.clear();
    }

    attachEvents() {
      this.canvas.addEventListener('mousedown', e => this.startDrawing(e));
      this.canvas.addEventListener('mousemove', e => this.draw(e));
      this.canvas.addEventListener('mouseup', e => this.stopDrawing());
      this.canvas.addEventListener('mouseout', e => this.stopDrawing());
      
      // Touch events
      this.canvas.addEventListener('touchstart', e => this.startDrawing(e.touches[0]));
      this.canvas.addEventListener('touchmove', e => this.draw(e.touches[0]));
      this.canvas.addEventListener('touchend', e => this.stopDrawing());
      this.canvas.addEventListener('touchcancel', e => this.stopDrawing());
    }

    startDrawing(e) {
      e.preventDefault();
      this.isDrawing = true;
      const rect = this.canvas.getBoundingClientRect();
      this.lastX = e.clientX - rect.left;
      this.lastY = e.clientY - rect.top;
    }

    draw(e) {
      if (!this.isDrawing) return;
      e.preventDefault();
      const rect = this.canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      this.ctx.beginPath();
      this.ctx.moveTo(this.lastX, this.lastY);
      this.ctx.lineTo(x, y);
      this.ctx.stroke();
      this.lastX = x;
      this.lastY = y;
    }

    stopDrawing() {
      this.isDrawing = false;
    }

    clear() {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }

    isEmpty() {
      const blank = document.createElement('canvas');
      blank.width = this.canvas.width;
      blank.height = this.canvas.height;
      return this.canvas.toDataURL() === blank.toDataURL();
    }

    toDataURL() {
      return this.canvas.toDataURL('image/png');
    }
  }

  // Inicializar todos os signature pads e seus botões limpar
  const signaturePads = new Map();
  function setupSignaturePads() {
    document.querySelectorAll('.page').forEach(page => {
      const canvas = page.querySelector('canvas.signature-pad');
      if(canvas) {
        const pad = new SignaturePadWrapper(canvas);
        signaturePads.set(canvas, pad);

        const btnClear = page.querySelector('button.btn-clear-signature');
        if(btnClear) {
          btnClear.onclick = () => pad.clear();
        }
      }
    });
  }

  setupSignaturePads();

  // Mostrar/ocultar área de alteração conforme seleção
  function setupAlteracaoSelects() {
    document.querySelectorAll('.alteracao-select').forEach(select => {
      select.addEventListener('change', e => {
        const val = e.target.value;
        const parent = e.target.closest('section.page');
        const area = parent.querySelector('.alteracao-area');
        if(val === 'sim') {
          area.classList.remove('hidden');
          // Tornar obrigatórios
          area.querySelector('textarea').required = true;
        } else {
          area.classList.add('hidden');
          // Limpar e tornar não obrigatórios
          const ta = area.querySelector('textarea');
          ta.value = '';
          ta.required = false;
          const fileInput = area.querySelector('input[type=file]');
          fileInput.value = '';
        }
      });
    });
  }
  setupAlteracaoSelects();

  // Função para gerar PDF
  async function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const margin = 15;
    let y = margin;
    const lineHeight = 7;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    function addPageIfNeeded(extraHeight=0) {
      if(y + extraHeight > pageHeight - margin) {
        doc.addPage();
        y = margin;
      }
    }

    function addText(text, fontSize=12, fontStyle='normal') {
      doc.setFontSize(fontSize);
      doc.setFont(undefined, fontStyle);
      const splitText = doc.splitTextToSize(text, pageWidth - margin*2);
      addPageIfNeeded(splitText.length * lineHeight);
      doc.text(splitText, margin, y);
      y += splitText.length * lineHeight;
    }

    function addTitle(text) {
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      addPageIfNeeded(lineHeight * 2);
      doc.text(text, pageWidth/2, y, {align: 'center'});
      y += lineHeight * 2;
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(margin, y-4, pageWidth - margin, y-4);
    }

    // Adicionar Preleção
    addTitle('Preleção Diária');
    const assuntos = document.getElementById('assuntosTratados').value.trim();
    const colaboradores = document.getElementById('colaboradoresPresentes').value.trim();
    const dataVal = document.getElementById('data').value;
    const horaVal = document.getElementById('hora').value;
    const encarregado = document.getElementById('encarregado').value.trim();
    const local = document.getElementById('local').value.trim();

    addText(`Data: ${dataVal}    Hora: ${horaVal}`);
    addText(`Local: ${local}`);
    addText(`Encarregado Responsável: ${encarregado}`);
    addText(`Assuntos Tratados:\n${assuntos}`);
    addText(`Colaboradores Presentes:\n${colaboradores}`);

    // Adicionar páginas dos postos
    for(let i=0; i<postos.length; i++) {
      doc.addPage();
      y = margin;
      addTitle(`Posto: ${postos[i]}`);

      const page = document.querySelector(`.page[data-page="${i+1}"]`);

      const alteracaoSelect = page.querySelector('.alteracao-select');
      const alteracaoVal = alteracaoSelect.value;
      addText(`Houve alteração no posto? ${alteracaoVal === 'sim' ? 'Sim' : 'Não'}`);

      if(alteracaoVal === 'sim') {
        const descricao = page.querySelector('.descricao-alteracao').value.trim();
        addText(`Descrição da alteração:\n${descricao}`);

        const fileInput = page.querySelector('input.input-imagem-alteracao');
        if(fileInput.files.length > 0) {
          for(let f=0; f<fileInput.files.length; f++) {
            const file = fileInput.files[f];
            if(!file.type.startsWith('image/')) continue;
            const imgData = await readFileAsDataURL(file);
            const img = new Image();
            img.src = imgData;
            await new Promise(res => { img.onload = res; });

            const imgWidthMax = pageWidth - margin*2;
            let imgWidth = img.width;
            let imgHeight = img.height;
            if(imgWidth > imgWidthMax) {
              const ratio = imgWidthMax / imgWidth;
              imgWidth = imgWidthMax;
              imgHeight = imgHeight * ratio;
            }
            addPageIfNeeded(imgHeight + lineHeight);
            doc.addImage(imgData, 'JPEG', margin, y, imgWidth, imgHeight);
            y += imgHeight + lineHeight;
          }
        }
      }

      const colaborador = page.querySelector('.nome-colaborador').value.trim();
      addText(`Colaborador que assumiu: ${colaborador}`);

      // Assinatura
      const canvas = page.querySelector('canvas.signature-pad');
      const pad = signaturePads.get(canvas);
      if(pad && !pad.isEmpty()) {
        const sigImg = pad.toDataURL();
        const img = new Image();
        img.src = sigImg;
        await new Promise(res => { img.onload = res; });
        const sigWidthMax = 150;
        const ratio = sigWidthMax / img.width;
        const sigWidth = sigWidthMax;
        const sigHeight = img.height * ratio;
        addPageIfNeeded(sigHeight + lineHeight);
        doc.addImage(sigImg, 'PNG', margin, y, sigWidth, sigHeight);
        y += sigHeight + lineHeight;
      } else {
        addText("(Sem assinatura)");
      }
    }

    // Salvar PDF
    doc.save(`Prelecao_Diaria_${dataVal}.pdf`);
  }

  // Helper para ler arquivos de input file como base64
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  // Botões próximos nos postos
  app.addEventListener('click', e => {
    if(e.target.classList.contains('btn-next-posto')) {
      const pageNum = parseInt(e.target.closest('section.page').dataset.page);
      // Validação
      const page = document.querySelector(`.page[data-page="${pageNum}"]`);

      const alteracaoSelect = page.querySelector('.alteracao-select');
      if(!alteracaoSelect.value) {
        alert('Por favor, selecione se houve alteração.');
        return;
      }
      if(alteracaoSelect.value === 'sim') {
        const desc = page.querySelector('.descricao-alteracao');
        if(!desc.value.trim()) {
          alert('Por favor, descreva a alteração.');
          return;
        }
      }
      const colaborador = page.querySelector('.nome-colaborador');
      if(!colaborador.value.trim()) {
        alert('Por favor, informe o nome do colaborador que está assumindo o posto.');
        return;
      }
      // assinatura obrigatória
      const canvas = page.querySelector('canvas.signature-pad');
      const pad = signaturePads.get(canvas);
      if(pad.isEmpty()) {
        alert('Por favor, realize a assinatura.');
        return;
      }

      if(pageNum < totalPages -1) {
        currentPage++;
        showPage(currentPage);
      } else {
        // último posto, gera pdf
        gerarPDF();
      }
    }
  });
</script>

</body>
</html>
